async function loadJSON(path){try{const r=await fetch(path);return await r.json()}catch(e){console.error(e);return[]}}function qs(s){return document.querySelector(s)}function qsa(s){return Array.from(document.querySelectorAll(s))}function avatar(seed,style='micah'){return'https://avatars.dicebear.com/api/'+style+'/'+encodeURIComponent(seed)+'.svg?background=%23ffffff'}function createElem(tag,attrs={},inner=''){const e=document.createElement(tag);for(const k in attrs)e.setAttribute(k,attrs[k]);if(inner)e.innerHTML=inner;return e}function profileCard(p){const c=createElem('div',{class:'card profile'});c.innerHTML=`<div class="profile-avatar"><img src="${p.image||avatar(p.name,'micah')}" alt="${p.name}" style="width:100%;height:100%;object-fit:cover"></div><div class="profile-meta"><h4>${p.name}</h4><div class="muted">${p.role}</div><p class="muted small">Source: <a href="${p.source}" target="_blank">link</a></p></div>`;return c}function newsCard(n){const c=createElem('div',{class:'card'});c.innerHTML=`<h4>${n.title}</h4><p class="muted">${n.source} · ${n.region||'all'}</p><p>${n.excerpt}</p><a class="btn btn-outline" href="${n.link}" target="_blank">Read</a>`;return c}function eventCard(e){const c=createElem('div',{class:'card'});c.innerHTML=`<h4>${e.title}</h4><p class="muted">${e.date} · ${e.location||''}</p><p>${e.description}</p>`;const btn=createElem('button',{class:'btn btn-primary'},'RSVP');const id='rsvp_'+(e.title+e.date).replace(/\s+/g,'_');if(localStorage.getItem(id)){btn.textContent='RSVP’d ✓';btn.disabled=true}btn.addEventListener('click',()=>{localStorage.setItem(id,'1');btn.textContent='RSVP’d ✓';btn.disabled=true});c.appendChild(btn);return c}function marketCard(m){const c=createElem('div',{class:'card'});c.innerHTML=`<img src="${m.image}" class="market-img" alt="${m.title}"/><h4>${m.title}</h4><p class="muted">${m.price||''} · ${m.location||''}</p><p>${m.description}</p><div style="margin-top:8px"><button class="btn btn-primary buy-btn">Contact</button></div>`;c.querySelector('.buy-btn').addEventListener('click',()=>alert('Contact seller: '+(m.contact||'Not provided')));return c}async function boot(){const profiles=await loadJSON('data/profiles.json');const news=await loadJSON('data/news.json');const events=await loadJSON('data/events.json');const legends=await loadJSON('data/legends.json');const market=await loadJSON('data/market.json');qs('#stat-profiles').textContent=profiles.length;qs('#stat-events').textContent=events.length;qs('#stat-news').textContent=news.length;const spot=qs('#spotlight-small');profiles.slice(0,8).forEach(p=>{const s=createElem('div',{class:'spot'});const img=createElem('img',{src:p.image||avatar(p.name,'bottts'),alt:p.name});img.style.width='100%';img.style.height='100%';img.style.objectFit='cover';s.appendChild(img);s.title=p.name;spot.appendChild(s)});const pg=qs('#profiles-grid');pg.innerHTML='';profiles.forEach(p=>pg.appendChild(profileCard(p)));const cg=qs('#coaches-grid');cg.innerHTML='';profiles.filter(p=>p.is_coach).forEach(c=>cg.appendChild(profileCard(c)));const ng=qs('#news-grid');function renderNews(filter='all',q=''){ng.innerHTML='';const filtered=news.filter(n=>(filter==='all'||n.region===filter)&&(q===''||(n.title+' '+n.excerpt).toLowerCase().includes(q.toLowerCase())));if(filtered.length===0){ng.innerHTML='<div class="card">No results</div>';return}filtered.forEach(n=>ng.appendChild(newsCard(n)))}renderNews('all','');qs('#news-filter').addEventListener('change',e=>renderNews(e.target.value,qs('#news-search').value));qs('#news-search').addEventListener('input',e=>renderNews(qs('#news-filter').value,e.target.value));const eg=qs('#events-grid');eg.innerHTML='';events.forEach(ev=>eg.appendChild(eventCard(ev)));const lg=qs('#legends-grid');lg.innerHTML='';legends.forEach(l=>{const c=createElem('div',{class:'card'},`<h4>${l.name}</h4><p class='muted'>${l.type||''}</p><p>${l.story}</p><p class='muted small'>Source: ${l.source}</p>`);lg.appendChild(c)});const mg=qs('#market-grid');mg.innerHTML='';market.forEach(m=>mg.appendChild(marketCard(m)));qs('#create-listing').addEventListener('click',()=>{const title=prompt('Listing title (e.g., Fresh maize 50kg)');if(!title)return;const price=prompt('Price (e.g., KES 2000)');const image=prompt('Image URL (paste public image URL)');const desc=prompt('Short description');const loc=prompt('Location');const contact=prompt('Contact phone/email');const obj={title,price,description:desc,image:image||'assets/images/market.svg',location:loc,contact};market.unshift(obj);localStorage.setItem('kupa_market',JSON.stringify(market));mg.insertBefore(marketCard(obj),mg.firstChild);alert('Listing created (stored in browser).')});const saved=localStorage.getItem('kupa_market');if(saved){try{const s=JSON.parse(saved);if(Array.isArray(s)){s.forEach(m=>mg.insertBefore(marketCard(m),mg.firstChild))}}catch(e){console.error(e)}}qs('#open-lightbox').addEventListener('click',()=>{qs('#lightbox').style.display='flex';qs('#lightbox').setAttribute('aria-hidden','false')});qs('#close-lightbox').addEventListener('click',()=>{qs('#lightbox').style.display='none';qs('#lightbox').setAttribute('aria-hidden','true')});const form=qs('#join-form');qs('#export-join').addEventListener('click',()=>{const fd=new FormData(form);const obj={};fd.forEach((v,k)=>obj[k]=v);const dataStr='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(obj));const a=createElem('a',{href:dataStr,download:'kupa-join.json'});document.body.appendChild(a);a.click();a.remove()});form.addEventListener('submit',(e)=>{e.preventDefault();const fd=new FormData(form);const obj={};fd.forEach((v,k)=>obj[k]=v);const key='kupa_join_'+Date.now();localStorage.setItem(key,JSON.stringify(obj));alert('Thanks — recorded locally.');form.reset()})}document.addEventListener('DOMContentLoaded',()=>setTimeout(()=>boot(),200));